#!/usr/bin/env bash
#MISE description="Publish to npm registry"
#MISE depends=["setup", "build"]
#USAGE flag "-t --tag <tag>" "Tag to publish with" default="latest"

set -e

echo "Publishing to npm"
echo " > with tag: ${usage_tag}..."
echo " > npm version: $(npm --version)"

# Determine if we should use provenance
# Only enable in CI environments with OIDC support
PROVENANCE_FLAG=""
if [ -z "$GITHUB_ACTIONS" ]; then
  # Local development: disable provenance (fails without CI provider context)
  PROVENANCE_FLAG="--no-provenance"
  echo " > provenance: disabled (local environment)"
else
  # GitHub Actions: enable provenance (OIDC will handle it automatically)
  echo " > provenance: enabled (GitHub Actions with OIDC)"
fi

# Publish directly from source (allows provenance generation in CI)
npm publish \
  --access public \
  --tag "${usage_tag}" \
  $PROVENANCE_FLAG

echo "Published successfully!"
